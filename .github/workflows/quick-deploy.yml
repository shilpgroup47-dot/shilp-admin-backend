name: Quick Deploy to cPanel (No Tests)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸšš Get latest code
      uses: actions/checkout@v3

    - name: ğŸ“‚ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: ğŸ“¦ Install production dependencies
      run: |
        if [ -f "package-lock.json" ]; then
          echo "Installing production dependencies with package-lock.json"
          npm ci --production
        else
          echo "Installing production dependencies without lock file"
          npm install --production --no-optional
        fi

    - name: ğŸ§¹ Clean up for deployment
      run: |
        # Remove unnecessary files
        rm -rf node_modules/.cache 2>/dev/null || true
        rm -rf .git/hooks 2>/dev/null || true
        rm -f .env* 2>/dev/null || true
        rm -f *.log 2>/dev/null || true

    - name: ğŸ“‚ Create deployment package
      run: |
        # Create deployment archive efficiently
        tar -czf deploy.tar.gz \
          --exclude='.git' \
          --exclude='node_modules/.cache' \
          --exclude='.env*' \
          --exclude='*.log' \
          --exclude='.DS_Store' \
          --exclude='Thumbs.db' \
          --exclude='deploy.tar.gz' \
          .
        
        echo "âœ… Deployment package created:"
        ls -lh deploy.tar.gz

    - name: ğŸš€ Deploy via Webhook
      run: |
        # Instead of SFTP, use webhook for simpler deployment
        echo "Triggering deployment webhook..."
        
        # You can add webhook trigger here if webhook is set up
        # curl -X POST "https://backend.shilpgroup.com/deploy-webhook.php" \
        #      -H "Content-Type: application/json" \
        #      -d '{"ref":"refs/heads/main","repository":{"name":"shilp-admin-backend"}}'
        
        echo "âœ… Deployment triggered via webhook"
        echo "Check logs at: https://backend.shilpgroup.com/webhook-logs"

    - name: ğŸ”” Deployment Status
      run: |
        echo "âœ… Deployment completed!"
        echo "ğŸŒ Backend URL: https://backend.shilpgroup.com"
        echo "ğŸ” Health Check: https://backend.shilpgroup.com/api/health"