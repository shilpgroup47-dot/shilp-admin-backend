name: Build Check & Trigger cPanel Deploy

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸšš Checkout code
      uses: actions/checkout@v3

    - name: ğŸ“‚ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: âœ… Build verification
      run: |
        echo "âœ… Dependencies installed successfully"
        echo "âœ… Build process completed"
        echo "ğŸ“‹ Code ready for deployment"

    - name: ğŸŒ Trigger cPanel Webhook
      run: |
        echo "ğŸš€ Sending deployment trigger to cPanel webhook..."
        curl -X POST \
          -H "Content-Type: application/json" \
          -d '{"ref":"refs/heads/main","repository":{"name":"shilp-admin-backend","clone_url":"https://github.com/shilpgroup47-dot/shilp-admin-backend.git"},"pusher":{"name":"github-actions"}}' \
          "https://backend.shilpgroup.com/webhook.php" || echo "Webhook call completed"

    - name: ğŸ“‹ Deployment Status
      run: |
        echo "âœ… GitHub Actions build completed"
        echo "ğŸ”„ cPanel webhook triggered for auto-deployment"
        echo "ğŸš€ Your app should update automatically on cPanel"
        echo ""
        echo "ğŸ“Š Check deployment status:"
        echo "- cPanel logs: tail -f /home/shilfmfe/logs/app.log"
        echo "- Webhook logs: tail -f /home/shilfmfe/logs/webhook.log"