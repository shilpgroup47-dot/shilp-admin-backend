name: Deploy to cPanel

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸšš Get latest code
      uses: actions/checkout@v3

    - name: ğŸ“‚ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: ğŸ” Install dependencies
      run: npm ci --production

    - name: ğŸ“‚ Create deployment files
      run: |
        # Create .env.production from template
        cp .env.example .env.production
        
        # Remove unnecessary files
        rm -rf .git
        rm -f .env
        rm -f .env.development
        
        echo "âœ… Deployment files prepared"

    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: server.shilpgroup.com
        username: shilfmfe
        password: ${{ secrets.CPANEL_PASSWORD }}
        port: 22
        timeout: 300s
        script: |
          # Navigate to deployment directory
          cd /home/shilfmfe/server_running
          
          # Stop existing application
          echo "â¹ï¸ Stopping existing application..."
          pkill -f "node src/server.js" || echo "No existing process found"
          
          # Backup current deployment
          if [ -d "backend.shilpgroup.com" ]; then
            echo "ğŸ“¦ Creating backup..."
            # Backup uploads separately
            if [ -d "backend.shilpgroup.com/uploads" ]; then
              cp -R backend.shilpgroup.com/uploads uploads_backup_$(date +%Y%m%d_%H%M%S)
            fi
            # Archive old deployment
            mv backend.shilpgroup.com backup_$(date +%Y%m%d_%H%M%S) || true
          fi
          
          # Clone fresh code
          echo "ğŸ“¥ Cloning latest code..."
          git clone https://github.com/shilpgroup47-dot/shilp-admin-backend.git backend.shilpgroup.com
          
          # Setup application
          cd backend.shilpgroup.com
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --production
          
          # Restore uploads if backup exists
          if [ -d "/home/shilfmfe/server_running/uploads_backup_$(date +%Y%m%d_%H%M%S)" ]; then
            echo "ğŸ”„ Restoring uploads..."
            cp -R /home/shilfmfe/server_running/uploads_backup_$(date +%Y%m%d_%H%M%S)/* uploads/ 2>/dev/null || true
          fi
          
          # Create uploads directories
          mkdir -p uploads/{banners,blogs,projects,projecttree}
          chmod 755 uploads uploads/* 2>/dev/null || true
          
          # Make scripts executable
          chmod +x *.sh 2>/dev/null || true
          
          # Create production environment
          cp .env.example .env
          
          # Start application
          echo "ğŸš€ Starting application..."
          export NODE_ENV=production
          export PORT=8081
          nohup node src/server.js > /home/shilfmfe/logs/app.log 2>&1 &
          
          # Wait and verify
          sleep 5
          if pgrep -f "node src/server.js" > /dev/null; then
            echo "âœ… Application started successfully!"
          else
            echo "âŒ Application failed to start"
            echo "Last 10 lines of log:"
            tail -10 /home/shilfmfe/logs/app.log 2>/dev/null || echo "No log file found"
            exit 1
          fi
          
          # Cleanup old backups (keep last 3)
          cd /home/shilfmfe/server_running
          ls -1t backup_* 2>/dev/null | tail -n +4 | xargs rm -rf || true
          ls -1t uploads_backup_* 2>/dev/null | tail -n +4 | xargs rm -rf || true
          
          echo "ğŸ‰ Deployment completed successfully!"

    - name: ğŸ”” Deployment Result
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Your backend should be running at: https://backend.shilpgroup.com"
        else
          echo "âŒ Deployment failed - check the logs above"
        fi