name: Deploy to cPanel

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸšš Get latest code
      uses: actions/checkout@v3

    - name: ğŸ“‚ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        # Only use cache if package-lock.json exists
        cache: ${{ hashFiles('**/package-lock.json') && 'npm' || '' }}

    - name: ğŸ” Install dependencies
      run: |
        if [ -f "package-lock.json" ]; then
          echo "Using package-lock.json for exact dependency versions"
          npm ci --production
        else
          echo "No package-lock.json found, using npm install"
          npm install --production
        fi

    - name: ğŸ§ª Run tests (if available)
      run: |
        if [ -f "jest.config.js" ] || [ "$(grep -c "\"test\"" package.json)" -gt 0 ]; then
          npm test
        else
          echo "No tests found, skipping..."
        fi
      continue-on-error: true

    - name: ğŸ“‚ Create deployment package
      run: |
        # Remove development files
        rm -rf node_modules/.cache
        rm -rf .git
        rm -f .env
        rm -f .env.development
        
        # Create deployment archive
        tar -czf deploy.tar.gz --exclude='.git' --exclude='node_modules/.cache' --exclude='.env*' .

    - name: ğŸš€ Deploy to cPanel via SFTP
      uses: wlixcc/SFTP-Deploy-Action@v1.2.4
      with:
        username: ${{ secrets.CPANEL_USERNAME }}
        password: ${{ secrets.CPANEL_PASSWORD }}
        server: ${{ secrets.CPANEL_SERVER }}
        port: ${{ secrets.CPANEL_PORT }} # Usually 22 for SFTP
        local_path: './deploy.tar.gz'
        remote_path: '/home/shilfmfe/server_running/'
        
    - name: ğŸ”§ Extract and setup on server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.CPANEL_SERVER }}
        username: ${{ secrets.CPANEL_USERNAME }}
        password: ${{ secrets.CPANEL_PASSWORD }}
        port: ${{ secrets.CPANEL_PORT }}
        script: |
          cd ~/server_running
          
          # Backup uploads directory (preserve user files)
          if [ -d "backend.shilpgroup.com/uploads" ]; then
            echo "ğŸ’¾ Backing up uploads directory..."
            cp -R backend.shilpgroup.com/uploads uploads_backup_$(date +%Y%m%d_%H%M%S)
          fi
          
          # Backup current deployment (without uploads)
          if [ -d "backend.shilpgroup.com" ]; then
            echo "ğŸ“¦ Backing up current deployment..."
            rsync -av --exclude='uploads/' backend.shilpgroup.com/ backend_backup_$(date +%Y%m%d_%H%M%S)/
            rm -rf backend.shilpgroup.com
          fi
          
          # Extract new deployment
          echo "ğŸ“¥ Extracting new deployment..."
          tar -xzf deploy.tar.gz -C ./
          mv shilp-admin-backend backend.shilpgroup.com || echo "Directory already named correctly"
          
          # Restore uploads directory
          if [ -d "uploads_backup_$(date +%Y%m%d_%H%M%S)" ]; then
            echo "ğŸ”„ Restoring uploads directory..."
            cp -R uploads_backup_$(date +%Y%m%d_%H%M%S) backend.shilpgroup.com/uploads
            rm -rf uploads_backup_$(date +%Y%m%d_%H%M%S)
          fi
          
          # Setup environment
          cd backend.shilpgroup.com
          cp .env.example .env
          
          # Install production dependencies
          npm ci --production
          
          # Create upload directories
          mkdir -p uploads/{banners,blogs,projects,projecttree}
          chmod 755 uploads uploads/*
          
          # Set permissions
          chmod +x *.sh
          
          # Cleanup
          rm -f ~/public_html/deploy.tar.gz
          
          echo "âœ… Deployment completed successfully!"

    - name: ğŸ”” Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
        else
          echo "âŒ Deployment failed!"
          exit 1
        fi