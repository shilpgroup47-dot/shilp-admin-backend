name: Auto Deploy Backend (FTP Only)

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì¶ Checkout Repository
      uses: actions/checkout@v3

    - name: üìÅ Build Deployment Package
      run: |
        mkdir deploy_package
        cp app.js deploy_package/
        cp -r src deploy_package/
        cp package.json deploy_package/
        cp package-lock.json deploy_package/
        cp .env.example deploy_package/.env
        cp .cpanel.yml deploy_package/
        cp auto-deploy.sh deploy_package/
        cp restart-app.sh deploy_package/
        cp restart.php deploy_package/
        cp loader.cjs deploy_package/
        cp -r uploads deploy_package/

        chmod +x deploy_package/*.sh

    - name: üöÄ Deploy via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.CPANEL_FTP_SERVER }}
        username: ${{ secrets.CPANEL_FTP_USERNAME }}
        password: ${{ secrets.CPANEL_FTP_PASSWORD }}
        server-dir: ${{ secrets.CPANEL_FTP_SERVER_DIR }}
        local-dir: ./deploy_package/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.DS_Store
          **/Thumbs.db

    - name: üîÑ Auto Restart via PHP Script (No SSH)
      run: |
        echo "Attempting to restart Node.js application..."
        
        # Try restart with retry logic
        for i in {1..3}; do
          echo "Restart attempt $i/3..."
          
          response=$(curl -s -w "%{http_code}" \
            -H "User-Agent: GitHub-Actions-Deploy" \
            https://backend.shilpgroup.com/restart.php || echo "000")
          
          http_code=$(echo "$response" | tail -c 4)
          response_body=$(echo "$response" | head -c -4)
          
          echo "HTTP Status: $http_code"
          echo "Response: $response_body"
          
          if [ "$http_code" = "200" ]; then
            echo "‚úÖ Restart successful!"
            break
          else
            echo "‚ùå Restart attempt $i failed (HTTP $http_code)"
            if [ $i -lt 3 ]; then
              echo "Waiting 10 seconds before next attempt..."
              sleep 10
            fi
          fi
        done
        
        # Final health check
        echo "Performing final health check..."
        sleep 5
        health_response=$(curl -s -w "%{http_code}" https://backend.shilpgroup.com/api/health || echo "000")
        health_code=$(echo "$health_response" | tail -c 4)
        
        if [ "$health_code" = "200" ]; then
          echo "‚úÖ Application is healthy and running!"
        else
          echo "‚ö†Ô∏è Warning: Health check failed (HTTP $health_code)"
        fi

    - name: üéâ Deployment Complete
      run: echo "‚úÖ FTP-only deploy completed successfully!"
